<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-SERV BOT - Chatbot Interno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Apache ECharts for Generative BI -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'iserv-green': '#009639',
                        'iserv-dark-green': '#00843D',
                        'iserv-black': '#1a1a1a',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .chat-container {
            height: calc(100vh - 80px);
        }
        
        .messages-container {
            height: calc(100% - 80px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: #009639;
            border-radius: 3px;
        }

        /* Added typing indicator animation */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #009639;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-6px);
                opacity: 1;
            }
        }

        /* Generative BI Chart Styles */
        .chart-container {
            width: 100%;
            min-height: 320px;
            margin: 12px 0;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .chart-wrapper {
            width: 100%;
            height: 320px;
        }

        .data-table-container {
            width: 100%;
            margin: 12px 0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table thead {
            background: linear-gradient(135deg, #009639 0%, #00843D 100%);
        }

        .data-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .data-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #e2e8f0;
            color: #374151;
        }

        .data-table tbody tr:hover {
            background-color: #f0fdf4;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .data-table tbody tr:nth-child(even):hover {
            background-color: #f0fdf4;
        }

        .viz-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #009639 0%, #00843D 100%);
            color: white;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .viz-badge svg {
            width: 12px;
            height: 12px;
        }

        /* Markdown Content Styles */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content strong {
            font-weight: 600;
            color: #1f2937;
        }

        .markdown-content em {
            font-style: italic;
            color: #4b5563;
        }

        .markdown-list {
            list-style: none;
            padding-left: 0;
            margin: 4px 0;
        }

        .markdown-list-item {
            padding: 1px 0;
            padding-left: 16px;
            position: relative;
            line-height: 1.4;
        }

        .markdown-list-item::before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #009639;
            font-weight: bold;
            font-size: 0.9em;
        }

        .text-line {
            display: block;
            margin-bottom: 4px;
        }

        .text-line:last-child {
            margin-bottom: 0;
        }

        /* Thinking Chain Styles */
        .thinking-chain {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .thinking-header:hover {
            color: #0284c7;
        }

        .thinking-header svg {
            width: 18px;
            height: 18px;
            transition: transform 0.2s;
        }

        .thinking-header.collapsed svg {
            transform: rotate(-90deg);
        }

        .thinking-steps {
            padding-left: 8px;
            border-left: 3px solid #7dd3fc;
        }

        .thinking-steps.hidden {
            display: none;
        }

        .thinking-step {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            color: #475569;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .thinking-step:not(:last-child) {
            border-bottom: 1px dashed #cbd5e1;
        }

        .step-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .step-icon.query { background: #dbeafe; color: #1d4ed8; }
        .step-icon.schema { background: #fef3c7; color: #b45309; }
        .step-icon.sql { background: #d1fae5; color: #059669; }
        .step-icon.result { background: #ede9fe; color: #7c3aed; }
        .step-icon.analyze { background: #fce7f3; color: #db2777; }

        .step-content {
            flex: 1;
        }

        .step-label {
            font-weight: 600;
            color: #334155;
            margin-right: 4px;
        }

        .step-sql {
            background: #1e293b;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 0.75rem;
            margin-top: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Download Section Styles */
        .download-section {
            animation: fadeIn 0.3s ease-in-out;
        }

        .download-section button {
            transition: all 0.2s ease;
        }

        .download-section button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .markdown-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        /* Floating Suggested Prompts Panel */
        .suggested-prompts-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            max-height: 80vh;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .suggested-prompts-toggle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #009639 0%, #00843D 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 150, 57, 0.4);
            transition: all 0.3s ease;
            color: white;
        }

        .suggested-prompts-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 150, 57, 0.5);
        }

        .suggested-prompts-toggle svg {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .suggested-prompts-toggle.active svg {
            transform: rotate(45deg);
        }

        .suggested-prompts-container {
            display: none;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            max-width: 320px;
            max-height: calc(80vh - 70px);
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }

        .suggested-prompts-container.show {
            display: flex;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .suggested-prompts-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 4px;
        }

        .suggested-prompts-header svg {
            width: 18px;
            height: 18px;
            color: #009639;
        }

        .suggested-prompts-header span {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .prompt-btn {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 14px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .prompt-btn:hover {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #009639;
            transform: translateX(-4px);
            box-shadow: 0 2px 8px rgba(0, 150, 57, 0.15);
        }

        .prompt-btn:active {
            transform: translateX(-2px) scale(0.98);
        }

        .prompt-btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: linear-gradient(135deg, #009639 0%, #00843D 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .prompt-btn-icon svg {
            width: 14px;
            height: 14px;
            color: white;
        }

        .prompt-btn-text {
            font-size: 0.8rem;
            color: #374151;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .prompt-btn-text strong {
            color: #009639;
            font-weight: 600;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .suggested-prompts-panel {
                right: 10px;
                bottom: 100px;
                top: auto;
                transform: none;
            }

            .suggested-prompts-container {
                max-width: 280px;
            }

            .suggested-prompts-toggle {
                width: 44px;
                height: 44px;
            }
        }

        /* Scrollbar for prompts container */
        .suggested-prompts-container::-webkit-scrollbar {
            width: 4px;
        }

        .suggested-prompts-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        .suggested-prompts-container::-webkit-scrollbar-thumb {
            background: #009639;
            border-radius: 2px;
        }

        /* Dropdown Selector Styles */
        .dropdown-section {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #e5e7eb;
        }

        .dropdown-section:last-of-type {
            margin-bottom: 8px;
        }

        .dropdown-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .dropdown-label svg {
            width: 14px;
            height: 14px;
            color: #009639;
        }

        .search-dropdown {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 10px 36px 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            font-size: 0.85rem;
            color: #374151;
            background: white;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .search-input:focus {
            outline: none;
            border-color: #009639;
            box-shadow: 0 0 0 3px rgba(0, 150, 57, 0.15);
        }

        .search-input::placeholder {
            color: #9ca3af;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: #9ca3af;
            pointer-events: none;
        }

        .dropdown-list {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: none;
        }

        .dropdown-list.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 10px 12px;
            font-size: 0.8rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #009639;
        }

        .dropdown-item.selected {
            background: #009639;
            color: white;
        }

        .dropdown-item mark {
            background: #fef08a;
            color: inherit;
            padding: 0 2px;
            border-radius: 2px;
        }

        .dropdown-loading {
            padding: 12px;
            text-align: center;
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .dropdown-loading::after {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #e5e7eb;
            border-top-color: #009639;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dropdown-empty {
            padding: 12px;
            text-align: center;
            color: #9ca3af;
            font-size: 0.8rem;
            font-style: italic;
        }

        .dropdown-list::-webkit-scrollbar {
            width: 4px;
        }

        .dropdown-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        .dropdown-list::-webkit-scrollbar-thumb {
            background: #009639;
            border-radius: 2px;
        }

        /* Query Templates */
        .query-templates {
            margin-top: 8px;
        }

        .query-template-btn {
            display: block;
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 6px;
            font-size: 0.75rem;
            color: #6b7280;
            background: #f9fafb;
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
        }

        .query-template-btn:hover {
            background: #ecfdf5;
            border-color: #009639;
            color: #009639;
        }

        .query-template-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .query-template-btn strong {
            color: #009639;
        }

        /* Section divider */
        .section-divider {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
            color: #9ca3af;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .section-divider::before,
        .section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="/static/images/LOGO-I-SERV.png" alt="Logo de I‚ÄëSERV" class="h-12 w-auto" width="48" height="48" loading="lazy">
                <div>
                    <h1 class="text-xl font-bold text-iserv-black">I-SERV BOT</h1>
                    <p class="text-sm text-gray-500">Asistente Virtual Interno</p>
                </div>
            </div>
            <!-- Updated status indicator to be dynamic -->
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                    <div id="statusIndicator" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                    <span id="statusText" class="text-sm text-gray-600 font-medium">Conectando...</span>
                </div>
                <button 
                    id="clearHistoryBtn"
                    onclick="clearChatHistoryAndReload()"
                    class="text-xs text-gray-500 hover:text-red-600 transition-colors px-2 py-1 rounded hover:bg-gray-100"
                    title="Limpiar historial de conversaci√≥n"
                >
                    üóëÔ∏è Limpiar
                </button>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <main class="max-w-5xl mx-auto px-6 py-6">
        <div class="bg-white rounded-2xl shadow-lg chat-container">
            <!-- Messages Area -->
            <div class="messages-container p-6 space-y-4" id="messagesContainer">
                <!-- Removed example messages, they will be added dynamically -->
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <form id="chatForm" class="flex items-end gap-3">
                    <textarea 
                        id="messageInput"
                        rows="1"
                        placeholder="Escribe tu mensaje aqu√≠..."
                        class="flex-1 resize-none border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-iserv-green focus:border-transparent"
                        style="max-height: 120px;"
                    ></textarea>
                    <button 
                        type="submit"
                        id="sendButton"
                        class="bg-iserv-green text-white px-6 py-3 rounded-xl font-semibold hover:bg-iserv-dark-green transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span>Enviar</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Configuration - Read API_BASE_URL from meta tag or use current origin as fallback
        const apiBaseUrlMeta = document.querySelector('meta[name="api-base-url"]');
        const API_BASE_URL = apiBaseUrlMeta 
            ? apiBaseUrlMeta.getAttribute('content') 
            : (window.API_BASE_URL || window.location.origin);
        const APP_NAME = 'app';
        const USER_ID = 'web-user';

        // State
        let sessionId = null;
        let isProcessing = false;
        let chartCounter = 0; // For unique chart IDs

        // ============================================
        // GENERATIVE BI - Visualization Functions
        // ============================================

        /**
         * Parse response to extract Generative BI JSON block
         */
        function parseGenerativeBIResponse(text) {
            // Use unique delimiters that won't appear in JSON content
            const biRegex = /<<<GENERATIVE_BI_START>>>\n([\s\S]*?)\n<<<GENERATIVE_BI_END>>>/;
            const match = text.match(biRegex);
            
            if (match) {
                let jsonStr = match[1];
                console.log('[BI] Found generative-bi block, length:', jsonStr.length);
                
                try {
                    const biData = JSON.parse(jsonStr);
                    console.log('[BI] JSON parsed successfully');
                    console.log('[BI] Visualization:', biData.visualization?.type, '- visualizable:', biData.visualization?.visualizable);
                    
                    const textWithoutBI = text.replace(biRegex, '').trim();
                    return {
                        hasVisualization: biData.visualization && biData.visualization.visualizable,
                        biData: biData,
                        cleanText: textWithoutBI || biData.text
                    };
                } catch (e) {
                    // Extract position from error message
                    const posMatch = e.message.match(/position (\d+)/);
                    const errorPos = posMatch ? parseInt(posMatch[1]) : 0;
                    
                    console.error('[BI] Error parsing JSON:', e.message);
                    console.error('[BI] JSON length:', jsonStr.length);
                    console.error('[BI] Character at error position:', JSON.stringify(jsonStr.charAt(errorPos)));
                    console.error('[BI] Char code at error:', jsonStr.charCodeAt(errorPos));
                    console.error('[BI] Context around error (pos-50 to pos+50):', JSON.stringify(jsonStr.substring(errorPos - 50, errorPos + 50)));
                    console.error('[BI] Last 100 chars of JSON:', JSON.stringify(jsonStr.substring(jsonStr.length - 100)));
                    
                    // Try to fix truncated JSON
                    try {
                        jsonStr = jsonStr.trim();
                        
                        // Check if JSON appears truncated (doesn't end with })
                        if (!jsonStr.endsWith('}')) {
                            console.log('[BI] JSON appears truncated, attempting to fix...');
                            // Find the last complete object/array
                            let lastBrace = jsonStr.lastIndexOf('}');
                            let lastBracket = jsonStr.lastIndexOf(']');
                            
                            // Try to close the JSON properly
                            // Count open braces/brackets
                            let braces = 0, brackets = 0;
                            for (let c of jsonStr) {
                                if (c === '{') braces++;
                                else if (c === '}') braces--;
                                else if (c === '[') brackets++;
                                else if (c === ']') brackets--;
                            }
                            
                            console.log('[BI] Unclosed braces:', braces, 'brackets:', brackets);
                            
                            // Add closing brackets/braces
                            let suffix = ']'.repeat(brackets) + '}'.repeat(braces);
                            if (suffix) {
                                // Truncate to last complete row if in array
                                let truncated = jsonStr.substring(0, jsonStr.lastIndexOf('],') + 1);
                                if (truncated.length > jsonStr.length * 0.8) {
                                    jsonStr = truncated + ']}}}';  // Close rows, data, visualization, root
                                    console.log('[BI] Truncated and closed JSON');
                                }
                            }
                        }
                        
                        const biData = JSON.parse(jsonStr);
                        console.log('[BI] JSON parsed after fix');
                        const textWithoutBI = text.replace(biRegex, '').trim();
                        return {
                            hasVisualization: biData.visualization && biData.visualization.visualizable,
                            biData: biData,
                            cleanText: textWithoutBI || biData.text
                        };
                    } catch (e2) {
                        console.error('[BI] Fix attempt failed:', e2.message);
                        // Return the text without the malformed block
                        const textWithoutBI = text.replace(biRegex, '').trim();
                        return { hasVisualization: false, cleanText: textWithoutBI || text };
                    }
                }
            }
            
            return { hasVisualization: false, cleanText: text };
        }

        /**
         * Format axis label for better readability
         */
        function formatAxisLabel(label, fieldName) {
            if (!label) return fieldName || '';
            
            // If it's a monetary field, add currency indicator
            if (isMonetaryField(fieldName) || isMonetaryField(label)) {
                // Check if already has currency indicator
                if (!label.toUpperCase().includes('COP') && !label.includes('$')) {
                    return `${label} (COP)`;
                }
            }
            
            // Capitalize first letter and improve readability
            return label.charAt(0).toUpperCase() + label.slice(1).toLowerCase();
        }

        /**
         * Create chart configuration for ECharts based on visualization type
         */
        function createChartConfig(vizConfig) {
            const { type, title, xAxis, yAxis, xAxisLabel, yAxisLabel, series, data, groupBy, legend } = vizConfig;
            
            if (!data || !data.columns || !data.rows) {
                return null;
            }

            const xIndex = data.columns.indexOf(xAxis);
            const yIndex = data.columns.indexOf(yAxis) !== -1 ? data.columns.indexOf(yAxis) : 
                           (series && series[0] ? data.columns.indexOf(series[0].field) : 1);
            const groupIndex = groupBy ? data.columns.indexOf(groupBy) : -1;

            // Theme colors
            const colors = ['#009639', '#00843D', '#4ade80', '#166534', '#15803d', '#22c55e', '#86efac', 
                          '#10b981', '#059669', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'];
            
            // Helper function to group data by a dimension
            function groupDataByDimension(rows, xIndex, groupIndex, yIndex) {
                const grouped = {};
                const xValues = new Set();
                
                rows.forEach(row => {
                    const xValue = row[xIndex];
                    const groupValue = row[groupIndex];
                    const yValue = row[yIndex];
                    
                    xValues.add(xValue);
                    
                    if (!grouped[groupValue]) {
                        grouped[groupValue] = {};
                    }
                    grouped[groupValue][xValue] = yValue;
                });
                
                return { grouped, xValues: Array.from(xValues).sort() };
            }

            switch (type) {
                case 'bar':
                    // Auto-detect grouped bars if groupBy is present
                    if (groupIndex !== -1 && data.columns.length >= 3) {
                        return createChartConfig({ ...vizConfig, type: 'groupedBar' });
                    }
                    return {
                        title: { text: title, left: 'center', textStyle: { fontSize: 14, fontWeight: 600, color: '#1f2937' } },
                        tooltip: { 
                            trigger: 'axis', 
                            axisPointer: { type: 'shadow' },
                            formatter: function(params) {
                                if (!params || params.length === 0) return '';
                                const param = params[0];
                                const value = param.value;
                                const seriesName = param.seriesName || yAxis;
                                const formattedValue = isMonetaryField(yAxis) 
                                    ? formatCurrency(value) 
                                    : formatNumber(value, yAxis);
                                return `${param.axisValue}<br/>${seriesName}: ${formattedValue}`;
                            }
                        },
                        grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: data.rows.map(row => row[xIndex]),
                            axisLabel: { rotate: data.rows.length > 6 ? 30 : 0, fontSize: 11 },
                            name: formatAxisLabel(xAxisLabel, xAxis) || formatAxisLabel(xAxis, xAxis),
                            nameLocation: 'middle',
                            nameGap: 35,
                            nameTextStyle: { fontSize: 12, fontWeight: 500 }
                        },
                        yAxis: {
                            type: 'value',
                            name: formatAxisLabel(yAxisLabel, yAxis) || formatAxisLabel(yAxis, yAxis),
                            nameLocation: 'middle',
                            nameGap: 50,
                            nameTextStyle: { fontSize: 12, fontWeight: 500 },
                            axisLabel: { formatter: (val) => formatNumber(val, yAxis) }
                        },
                        series: [{
                            name: series && series[0] ? series[0].name : yAxis,
                            type: 'bar',
                            data: data.rows.map(row => row[yIndex]),
                            itemStyle: { 
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: '#009639' },
                                    { offset: 1, color: '#00843D' }
                                ]),
                                borderRadius: [4, 4, 0, 0]
                            },
                            emphasis: { itemStyle: { color: '#4ade80' } }
                        }]
                    };

                case 'line':
                    return {
                        title: { text: title, left: 'center', textStyle: { fontSize: 14, fontWeight: 600, color: '#1f2937' } },
                        tooltip: { 
                            trigger: 'axis',
                            formatter: function(params) {
                                if (!params || params.length === 0) return '';
                                const param = params[0];
                                const value = param.value;
                                const seriesName = param.seriesName || yAxis;
                                const formattedValue = isMonetaryField(yAxis) 
                                    ? formatCurrency(value) 
                                    : formatNumber(value, yAxis);
                                return `${param.axisValue}<br/>${seriesName}: ${formattedValue}`;
                            }
                        },
                        grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: data.rows.map(row => row[xIndex]),
                            axisLabel: { rotate: data.rows.length > 8 ? 30 : 0, fontSize: 11 },
                            name: xAxisLabel || xAxis,
                            nameLocation: 'middle',
                            nameGap: 35
                        },
                        yAxis: {
                            type: 'value',
                            name: yAxisLabel || yAxis,
                            nameLocation: 'middle',
                            nameGap: 50,
                            axisLabel: { formatter: (val) => formatNumber(val, yAxis) }
                        },
                        series: [{
                            name: series && series[0] ? series[0].name : yAxis,
                            type: 'line',
                            data: data.rows.map(row => row[yIndex]),
                            smooth: true,
                            lineStyle: { color: '#009639', width: 3 },
                            itemStyle: { color: '#009639' },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 150, 57, 0.3)' },
                                    { offset: 1, color: 'rgba(0, 150, 57, 0.05)' }
                                ])
                            }
                        }]
                    };

                case 'pie':
                    return {
                        title: { text: title, left: 'center', textStyle: { fontSize: 14, fontWeight: 600, color: '#1f2937' } },
                        tooltip: { 
                            trigger: 'item', 
                            formatter: function(params) {
                                const value = params.value;
                                const formattedValue = isMonetaryField(yAxis) 
                                    ? formatCurrency(value) 
                                    : formatNumber(value, yAxis);
                                return `${params.name}: ${formattedValue} (${params.percent}%)`;
                            }
                        },
                        legend: { orient: 'horizontal', bottom: '5%', left: 'center' },
                        series: [{
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['50%', '45%'],
                            avoidLabelOverlap: true,
                            itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                            label: { show: true, formatter: '{b}: {d}%' },
                            emphasis: {
                                label: { show: true, fontSize: 14, fontWeight: 'bold' },
                                itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                            },
                            data: data.rows.map((row, i) => ({
                                name: row[xIndex],
                                value: row[yIndex],
                                itemStyle: { color: colors[i % colors.length] }
                            }))
                        }]
                    };

                case 'area':
                    return {
                        title: { text: title, left: 'center', textStyle: { fontSize: 14, fontWeight: 600, color: '#1f2937' } },
                        tooltip: { 
                            trigger: 'axis', 
                            axisPointer: { type: 'cross' },
                            formatter: function(params) {
                                if (!params || params.length === 0) return '';
                                const param = params[0];
                                const value = param.value;
                                const seriesName = param.seriesName || yAxis;
                                const formattedValue = isMonetaryField(yAxis) 
                                    ? formatCurrency(value) 
                                    : formatNumber(value, yAxis);
                                return `${param.axisValue}<br/>${seriesName}: ${formattedValue}`;
                            }
                        },
                        grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: data.rows.map(row => row[xIndex]),
                            axisLabel: { rotate: data.rows.length > 8 ? 30 : 0, fontSize: 11 },
                            name: xAxisLabel || xAxis,
                            nameLocation: 'middle',
                            nameGap: 35
                        },
                        yAxis: {
                            type: 'value',
                            name: yAxisLabel || yAxis,
                            nameLocation: 'middle',
                            nameGap: 50,
                            axisLabel: { formatter: (val) => formatNumber(val, yAxis) }
                        },
                        series: [{
                            name: series && series[0] ? series[0].name : yAxis,
                            type: 'line',
                            stack: 'Total',
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 150, 57, 0.5)' },
                                    { offset: 1, color: 'rgba(0, 150, 57, 0.1)' }
                                ])
                            },
                            emphasis: { focus: 'series' },
                            lineStyle: { color: '#009639', width: 2 },
                            itemStyle: { color: '#009639' },
                            data: data.rows.map(row => row[yIndex])
                        }]
                    };

                case 'groupedBar':
                case 'stackedBar':
                    if (groupIndex === -1) {
                        // Fallback to regular bar if no groupBy
                        return createChartConfig({ ...vizConfig, type: 'bar' });
                    }
                    
                    const { grouped, xValues } = groupDataByDimension(data.rows, xIndex, groupIndex, yIndex);
                    const groupValues = Object.keys(grouped).sort();
                    
                    return {
                        title: { text: title, left: 'center', textStyle: { fontSize: 14, fontWeight: 600, color: '#1f2937' } },
                        tooltip: { 
                            trigger: 'axis', 
                            axisPointer: { type: 'shadow' },
                            formatter: function(params) {
                                if (!params || params.length === 0) return '';
                                let result = `${params[0].axisValue}<br/>`;
                                params.forEach(param => {
                                    const formattedValue = isMonetaryField(yAxis) 
                                        ? formatCurrency(param.value) 
                                        : formatNumber(param.value, yAxis);
                                    result += `${param.marker} ${param.seriesName}: ${formattedValue}<br/>`;
                                });
                                return result;
                            }
                        },
                        legend: {
                            show: legend && legend.show !== false,
                            data: legend && legend.data ? legend.data : groupValues,
                            orient: 'horizontal',
                            bottom: '0%',
                            left: 'center',
                            textStyle: { fontSize: 11 }
                        },
                        grid: { left: '3%', right: '4%', bottom: legend && legend.show !== false ? '15%' : '10%', top: '15%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: xValues,
                            axisLabel: { rotate: xValues.length > 8 ? 45 : 0, fontSize: 11 },
                            name: formatAxisLabel(xAxisLabel, xAxis) || formatAxisLabel(xAxis, xAxis),
                            nameLocation: 'middle',
                            nameGap: 35,
                            nameTextStyle: { fontSize: 12, fontWeight: 500 }
                        },
                        yAxis: {
                            type: 'value',
                            name: formatAxisLabel(yAxisLabel, yAxis) || formatAxisLabel(yAxis, yAxis),
                            nameLocation: 'middle',
                            nameGap: 50,
                            nameTextStyle: { fontSize: 12, fontWeight: 500 },
                            axisLabel: { formatter: (val) => formatNumber(val, yAxis) }
                        },
                        series: groupValues.map((groupValue, idx) => ({
                            name: groupValue,
                            type: 'bar',
                            stack: type === 'stackedBar' ? 'Total' : undefined,
                            data: xValues.map(xValue => grouped[groupValue][xValue] || 0),
                            itemStyle: { 
                                color: colors[idx % colors.length],
                                borderRadius: type === 'stackedBar' ? [0, 0, 0, 0] : [4, 4, 0, 0]
                            },
                            emphasis: { itemStyle: { color: colors[(idx + 1) % colors.length] } }
                        }))
                    };

                case 'multiLine':
                    if (groupIndex === -1) {
                        // Fallback to regular line if no groupBy
                        return createChartConfig({ ...vizConfig, type: 'line' });
                    }
                    
                    const lineGrouped = groupDataByDimension(data.rows, xIndex, groupIndex, yIndex);
                    const lineGroupValues = Object.keys(lineGrouped.grouped).sort();
                    
                    return {
                        title: { text: title, left: 'center', textStyle: { fontSize: 14, fontWeight: 600, color: '#1f2937' } },
                        tooltip: { 
                            trigger: 'axis',
                            formatter: function(params) {
                                if (!params || params.length === 0) return '';
                                let result = `${params[0].axisValue}<br/>`;
                                params.forEach(param => {
                                    const formattedValue = isMonetaryField(yAxis) 
                                        ? formatCurrency(param.value) 
                                        : formatNumber(param.value, yAxis);
                                    result += `${param.marker} ${param.seriesName}: ${formattedValue}<br/>`;
                                });
                                return result;
                            }
                        },
                        legend: {
                            show: legend && legend.show !== false,
                            data: legend && legend.data ? legend.data : lineGroupValues,
                            orient: 'horizontal',
                            bottom: '0%',
                            left: 'center',
                            textStyle: { fontSize: 11 }
                        },
                        grid: { left: '3%', right: '4%', bottom: legend && legend.show !== false ? '15%' : '10%', top: '15%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: lineGrouped.xValues,
                            axisLabel: { rotate: lineGrouped.xValues.length > 8 ? 30 : 0, fontSize: 11 },
                            name: formatAxisLabel(xAxisLabel, xAxis) || formatAxisLabel(xAxis, xAxis),
                            nameLocation: 'middle',
                            nameGap: 35
                        },
                        yAxis: {
                            type: 'value',
                            name: formatAxisLabel(yAxisLabel, yAxis) || formatAxisLabel(yAxis, yAxis),
                            nameLocation: 'middle',
                            nameGap: 50,
                            axisLabel: { formatter: (val) => formatNumber(val, yAxis) }
                        },
                        series: lineGroupValues.map((groupValue, idx) => ({
                            name: groupValue,
                            type: 'line',
                            smooth: true,
                            data: lineGrouped.xValues.map(xValue => lineGrouped.grouped[groupValue][xValue] || 0),
                            lineStyle: { color: colors[idx % colors.length], width: 3 },
                            itemStyle: { color: colors[idx % colors.length] },
                            emphasis: { focus: 'series' }
                        }))
                    };

                default:
                    return null;
            }
        }

        /**
         * Check if a field name suggests it's a monetary value
         */
        function isMonetaryField(fieldName) {
            if (!fieldName) return false;
            const fieldLower = String(fieldName).toLowerCase();
            const monetaryKeywords = ['total', 'precio', 'costo', 'valor', 'monto', 'factura', 'compra', 'venta', 'subtotal', 'iva', 'retefuente'];
            return monetaryKeywords.some(keyword => fieldLower.includes(keyword));
        }

        /**
         * Render thinking chain (chain of thought)
         */
        function renderThinkingChain(thinkingSteps) {
            if (!thinkingSteps || thinkingSteps.length === 0) return '';
            
            const thinkingId = `thinking-${Date.now()}`;
            
            let stepsHtml = thinkingSteps.map((step, index) => {
                let iconClass = 'query';
                let icon = 'üîç';
                
                if (step.type === 'schema') {
                    iconClass = 'schema';
                    icon = 'üìã';
                } else if (step.type === 'sql') {
                    iconClass = 'sql';
                    icon = 'üíæ';
                } else if (step.type === 'result') {
                    iconClass = 'result';
                    icon = 'üìä';
                } else if (step.type === 'analyze') {
                    iconClass = 'analyze';
                    icon = 'üß†';
                }
                
                let contentHtml = `<span class="step-label">${step.label || step.type}:</span> ${escapeHtml(step.content || '')}`;
                
                // If there's SQL, show it in a code block
                if (step.sql) {
                    contentHtml += `<div class="step-sql">${escapeHtml(step.sql)}</div>`;
                }
                
                return `
                    <div class="thinking-step">
                        <div class="step-icon ${iconClass}">${icon}</div>
                        <div class="step-content">${contentHtml}</div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="thinking-chain">
                    <div class="thinking-header" onclick="toggleThinking('${thinkingId}')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                        <span>üß† Cadena de Pensamiento</span>
                    </div>
                    <div id="${thinkingId}" class="thinking-steps">
                        ${stepsHtml}
                    </div>
                </div>
            `;
        }

        /**
         * Toggle thinking chain visibility
         */
        window.toggleThinking = function(id) {
            const steps = document.getElementById(id);
            const header = steps.previousElementSibling;
            steps.classList.toggle('hidden');
            header.classList.toggle('collapsed');
        };

        /**
         * Format monetary values without decimals
         */
        function formatCurrency(value) {
            if (value === null || value === undefined) return '-';
            const num = typeof value === 'number' ? value : parseFloat(value);
            if (isNaN(num)) return String(value);
            // Round to nearest integer and format with thousand separators
            return Math.round(num).toLocaleString('es-CO');
        }

        /**
         * Format large numbers for display in charts
         */
        function formatNumber(num, fieldName = '') {
            if (num === null || num === undefined) return '-';
            const numValue = typeof num === 'number' ? num : parseFloat(num);
            if (isNaN(numValue)) return String(num);
            
            // If it's a monetary field, format as currency
            if (isMonetaryField(fieldName)) {
                if (numValue >= 1000000) {
                    return (Math.round(numValue / 1000000)) + 'M';
                }
                if (numValue >= 1000) {
                    return (Math.round(numValue / 1000)) + 'K';
                }
                return Math.round(numValue).toLocaleString('es-CO');
            }
            
            // For non-monetary numbers, keep original logic but without decimals
            if (numValue >= 1000000) return Math.round(numValue / 1000000) + 'M';
            if (numValue >= 1000) return Math.round(numValue / 1000) + 'K';
            return Math.round(numValue).toLocaleString('es-CO');
        }

        /**
         * Render data as an interactive table
         */
        function renderDataTable(data, title) {
            if (!data || !data.columns || !data.rows || data.rows.length === 0) {
                return '<p class="text-gray-500 italic">No hay datos para mostrar</p>';
            }

            let tableHtml = `
                <div class="data-table-container">
                    ${title ? `<div class="px-4 py-2 bg-gray-50 border-b border-gray-200 font-semibold text-gray-700">${title}</div>` : ''}
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    ${data.columns.map(col => `<th>${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.rows.map(row => `
                                    <tr>
                                        ${row.map((cell, idx) => `<td>${formatCellValue(cell, data.columns[idx])}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return tableHtml;
        }

        /**
         * Format cell value for table display
         */
        function formatCellValue(value, columnName = '') {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'number') {
                // Check if it's a monetary field
                if (isMonetaryField(columnName)) {
                    return formatCurrency(value);
                }
                // For other numbers, show without decimals if they're whole numbers
                if (Number.isInteger(value)) {
                    return value.toLocaleString('es-CO');
                }
                return value.toLocaleString('es-CO', { maximumFractionDigits: 2 });
            }
            return String(value);
        }

        /**
         * Get icon SVG for visualization badge
         */
        function getVizIcon(type) {
            const icons = {
                bar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="6" width="4" height="15" rx="1"/><rect x="17" y="3" width="4" height="18" rx="1"/></svg>',
                line: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22,6 13.5,14.5 8.5,9.5 2,16"/><polyline points="16,6 22,6 22,12"/></svg>',
                pie: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>',
                area: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 18v-6l5-4 4 4 5-6 4 4v8H3z"/></svg>',
                table: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>'
            };
            return icons[type] || icons.table;
        }

        /**
         * Generate CSV content from data
         */
        function generateCSV(data, title = 'datos') {
            if (!data || !data.columns || !data.rows) return null;
            
            const BOM = '\uFEFF'; // UTF-8 BOM for Excel compatibility
            let csv = BOM;
            
            // Header row
            csv += data.columns.map(col => `"${String(col).replace(/"/g, '""')}"`).join(',') + '\n';
            
            // Data rows
            data.rows.forEach(row => {
                csv += row.map(cell => {
                    if (cell === null || cell === undefined) return '""';
                    const cellStr = String(cell).replace(/"/g, '""');
                    // Check if cell contains comma, newline, or quote
                    if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
                        return `"${cellStr}"`;
                    }
                    return cellStr;
                }).join(',') + '\n';
            });
            
            return csv;
        }

        /**
         * Download CSV file
         */
        function downloadCSV(data, filename = 'datos') {
            console.log('downloadCSV called with:', { data, filename });
            const csv = generateCSV(data, filename);
            if (!csv) {
                console.error('No data to download');
                alert('No hay datos para descargar');
                return;
            }
            
            try {
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                console.log('CSV download initiated');
            } catch (error) {
                console.error('Error downloading CSV:', error);
                alert('Error al descargar el archivo: ' + error.message);
            }
        }

        // Make downloadCSV available globally
        window.downloadCSV = downloadCSV;

        /**
         * Render download button for CSV
         */
        function renderDownloadButton(data, title, totalRecords) {
            if (!data || !data.columns || !data.rows || data.rows.length === 0) return '';
            
            const downloadId = `csvData_${++chartCounter}`;
            const filename = title ? title.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë\s]/g, '').replace(/\s+/g, '_').toLowerCase() : 'datos';
            
            // Store data for download in global scope
            window[downloadId] = { data, filename };
            
            return `
                <div class="download-section mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="text-sm text-blue-800">
                                <strong>${totalRecords} registros</strong> disponibles para descargar
                            </span>
                        </div>
                        <button 
                            onclick="window.downloadCSV(window.${downloadId}.data, window.${downloadId}.filename)"
                            class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors cursor-pointer"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            Descargar CSV
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Render visualization based on type
         */
        function renderVisualization(vizConfig) {
            console.log('[renderVisualization] Called with type:', vizConfig?.type, 'visualizable:', vizConfig?.visualizable);
            console.log('[renderVisualization] Data:', vizConfig?.data?.rows?.length, 'rows');
            
            const { type, title, data, fullData, isTop10, totalRecords, summary } = vizConfig;
            const chartId = `chart-${++chartCounter}`;

            // Determine which data to use for download (fullData if available, otherwise data)
            const downloadData = fullData && fullData.rows && fullData.rows.length > 0 ? fullData : data;
            const hasMoreData = totalRecords && totalRecords > 10;

            if (type === 'table' || type === 'none') {
                let html = renderDataTable(data, title);
                // Add download button if there's data
                if (hasMoreData && downloadData) {
                    html += renderDownloadButton(downloadData, title, totalRecords);
                }
                return html;
            }

            const chartConfig = createChartConfig(vizConfig);
            if (!chartConfig) {
                let html = renderDataTable(data, title);
                if (hasMoreData && downloadData) {
                    html += renderDownloadButton(downloadData, title, totalRecords);
                }
                return html;
            }

            // Top 10 indicator
            const top10Note = isTop10 && totalRecords > 10 
                ? `<div class="text-xs text-gray-500 mt-1 ml-1 italic">Mostrando Top 10 de ${totalRecords} registros totales</div>` 
                : '';

            // Download button if there are more records
            const downloadButton = hasMoreData && downloadData 
                ? renderDownloadButton(downloadData, title, totalRecords)
                : '';

            // Create chart container HTML
            const chartHtml = `
                <div class="viz-badge">
                    ${getVizIcon(type)}
                    <span>Generative BI - ${type.toUpperCase()}</span>
                </div>
                <div class="chart-container">
                    <div id="${chartId}" class="chart-wrapper"></div>
                </div>
                ${top10Note}
                ${downloadButton}
            `;

            // Schedule chart initialization after DOM insertion
            setTimeout(() => {
                const chartDom = document.getElementById(chartId);
                if (chartDom) {
                    const chart = echarts.init(chartDom);
                    chart.setOption(chartConfig);
                    
                    // Handle resize
                    window.addEventListener('resize', () => chart.resize());
                }
            }, 100);

            return chartHtml;
        }

        // DOM Elements
        const form = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const sendButton = document.getElementById('sendButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // ============================================
        // LOCALSTORAGE PERSISTENCE
        // ============================================
        const STORAGE_KEY = 'iserv_chat_history';
        const STORAGE_SESSION_KEY = 'iserv_session_id';
        const MAX_STORAGE_SIZE = 5 * 1024 * 1024; // 5MB limit

        /**
         * Save message to localStorage
         */
        function saveMessageToStorage(text, type, biData = null) {
            try {
                const messages = loadMessagesFromStorage();
                const messageData = {
                    text: text,
                    type: type,
                    timestamp: new Date().toISOString(),
                    biData: biData // Store Generative BI data if available
                };
                
                messages.push(messageData);
                
                // Limit to last 100 messages to prevent storage overflow
                const maxMessages = 50;
                if (messages.length > maxMessages) {
                    messages.splice(0, messages.length - maxMessages);
                }
                
                // Check storage size
                const dataStr = JSON.stringify(messages);
                if (dataStr.length > MAX_STORAGE_SIZE) {
                    // Remove oldest messages until under limit
                    while (dataStr.length > MAX_STORAGE_SIZE && messages.length > 10) {
                        messages.shift();
                    }
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
                console.log('[Storage] Message saved, total messages:', messages.length);
            } catch (e) {
                console.error('[Storage] Error saving message:', e);
                // If storage is full, try to clear old messages
                if (e.name === 'QuotaExceededError') {
                    console.warn('[Storage] Storage full, clearing old messages');
                    try {
                        const messages = loadMessagesFromStorage();
                        // Keep only last 20 messages
                        const recentMessages = messages.slice(-20);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(recentMessages));
                    } catch (e2) {
                        console.error('[Storage] Failed to clear old messages:', e2);
                    }
                }
            }
        }

        /**
         * Load messages from localStorage
         */
        function loadMessagesFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const messages = JSON.parse(stored);
                    console.log('[Storage] Loaded', messages.length, 'messages from storage');
                    return messages;
                }
            } catch (e) {
                console.error('[Storage] Error loading messages:', e);
                // Clear corrupted data
                localStorage.removeItem(STORAGE_KEY);
            }
            return [];
        }

        /**
         * Clear chat history from storage
         */
        function clearChatHistory() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STORAGE_SESSION_KEY);
                messagesContainer.innerHTML = '';
                console.log('[Storage] Chat history cleared');
            } catch (e) {
                console.error('[Storage] Error clearing history:', e);
            }
        }

        /**
         * Clear chat history and reload page
         */
        window.clearChatHistoryAndReload = function() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todo el historial de conversaci√≥n? Esta acci√≥n no se puede deshacer.')) {
                clearChatHistory();
                location.reload();
            }
        };

        /**
         * Save session ID to storage
         */
        function saveSessionId(id) {
            try {
                localStorage.setItem(STORAGE_SESSION_KEY, id);
            } catch (e) {
                console.error('[Storage] Error saving session ID:', e);
            }
        }

        /**
         * Load session ID from storage
         */
        function loadSessionId() {
            try {
                return localStorage.getItem(STORAGE_SESSION_KEY);
            } catch (e) {
                console.error('[Storage] Error loading session ID:', e);
                return null;
            }
        }

        /**
         * Restore messages from storage and render them
         */
        function restoreChatHistory() {
            const messages = loadMessagesFromStorage();
            if (messages.length === 0) {
                return false; // No history to restore
            }

            console.log('[Storage] Restoring', messages.length, 'messages');
            
            // Clear container first
            messagesContainer.innerHTML = '';
            
            // Restore each message
            messages.forEach(msg => {
                // Parse Generative BI data if present
                let biData = null;
                if (msg.biData) {
                    biData = msg.biData;
                }
                
                // Render message (reuse addMessage but skip saving to avoid duplicate)
                renderMessageFromStorage(msg.text, msg.type, biData);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return true; // History was restored
        }

        /**
         * Render message from storage (without saving again)
         */
        function renderMessageFromStorage(text, type, biData = null) {
            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            
            if (type === 'system') {
                messageDiv.className = 'flex justify-center';
                messageDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl px-4 py-2 max-w-xl">
                        <p class="text-yellow-800 text-sm text-center">${escapeHtml(text)}</p>
                    </div>
                `;
            } else if (type === 'user') {
                messageDiv.className = 'flex items-start gap-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="flex-1 flex flex-col items-end">
                        <div class="bg-iserv-green rounded-2xl rounded-tr-sm px-5 py-3 inline-block max-w-xl">
                            <p class="text-white leading-relaxed">${escapeHtml(text)}</p>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 mr-1">${time}</p>
                    </div>
                    <div class="w-10 h-10 bg-iserv-black rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                `;
            } else {
                // Bot message - Check for Generative BI visualization
                let messageContent = '';
                let visualizationHtml = '';
                let thinkingHtml = '';

                if (biData) {
                    const viz = biData.visualization;
                    const thinking = biData.thinking;
                    
                    // Render thinking chain if available
                    if (thinking && thinking.length > 0) {
                        thinkingHtml = renderThinkingChain(thinking);
                    }
                    
                    // Render the visualization
                    if (viz) {
                        visualizationHtml = renderVisualization(viz);
                    }
                    
                    // Use stored text
                    messageContent = biData.text || text;
                } else {
                    // Try to parse Generative BI from text
                    const biResult = parseGenerativeBIResponse(text);
                    if (biResult.hasVisualization || biResult.biData) {
                        const viz = biResult.biData?.visualization;
                        const thinking = biResult.biData?.thinking;
                        
                        if (thinking && thinking.length > 0) {
                            thinkingHtml = renderThinkingChain(thinking);
                        }
                        
                        if (viz) {
                            visualizationHtml = renderVisualization(viz);
                        }
                        
                        messageContent = biResult.biData?.text || biResult.cleanText;
                    } else {
                        messageContent = text;
                    }
                }

                messageDiv.className = 'flex items-start gap-3';
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-iserv-green rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1" style="max-width: calc(100% - 52px);">
                        ${thinkingHtml}
                        ${messageContent ? `
                        <div class="bg-gray-100 rounded-2xl rounded-tl-sm px-5 py-3 inline-block max-w-full">
                            <div class="text-gray-800 leading-relaxed whitespace-pre-wrap markdown-content">${renderMarkdown(messageContent)}</div>
                        </div>
                        ` : ''}
                        ${visualizationHtml}
                        <p class="text-xs text-gray-400 mt-1 ml-1">${time}</p>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
        }

        async function initializeSession() {
            try {
                updateStatus('Conectando...', false);

                // Try to restore chat history first
                const historyRestored = restoreChatHistory();
                
                // Try to restore session ID from storage
                const storedSessionId = loadSessionId();
                if (storedSessionId && historyRestored) {
                    console.log('[v0] Attempting to reuse stored session:', storedSessionId);
                    // Try to validate the session by checking if it still exists
                    // For now, we'll create a new session but keep the history
                }

                console.log('[v0] Attempting to connect to:', `${API_BASE_URL}/apps/${APP_NAME}/users/${USER_ID}/sessions`);

                const response = await fetch(`${API_BASE_URL}/apps/${APP_NAME}/users/${USER_ID}/sessions`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                console.log('[v0] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[v0] Error response:', errorText);
                    throw new Error(`Failed to create session: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                sessionId = data.id;
                saveSessionId(sessionId);

                updateStatus('En l√≠nea', true);
                console.log('[v0] Session initialized successfully:', sessionId);

                // Only add welcome message if no history was restored
                if (!historyRestored) {
                    addMessage('¬°Hola! Soy I-SERV BOT, tu asistente virtual para gesti√≥n interna. ¬øEn qu√© puedo ayudarte hoy?', 'bot');
                } else {
                    console.log('[v0] Chat history restored, skipping welcome message');
                }

            } catch (error) {
                console.error('[v0] Error initializing session:', error);
                updateStatus('Error de conexi√≥n', false);

                let errorMsg = 'No se pudo conectar al servidor. ';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg += 'Por favor verifica que la API est√© en ejecuci√≥n. ';
                }
                errorMsg += `Error: ${error.message}`;

                addMessage(errorMsg, 'system');
            }
        }

        function updateStatus(message, isConnected) {
            statusText.textContent = message;
            statusIndicator.className = `w-2 h-2 rounded-full ${isConnected ? 'bg-iserv-green animate-pulse' : 'bg-red-500'}`;
        }

        // Loading messages to show while processing
        const loadingMessages = [
            "Analizando tu consulta...",
            "Consultando la base de datos...",
            "Procesando los datos...",
            "Generando visualizaci√≥n...",
            "Preparando la respuesta...",
            "Casi listo...",
            "Organizando la informaci√≥n...",
            "Calculando resultados..."
        ];

        let loadingMessageInterval = null;
        let currentMessageIndex = 0;

        function getRandomLoadingMessage() {
            return loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
        }

        function setTyping(isTyping, customMessage = null) {
            const existingIndicator = document.getElementById('typingIndicator');
            
            if (isTyping && !existingIndicator) {
                const initialMessage = customMessage || getRandomLoadingMessage();
                currentMessageIndex = 0;
                
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'flex items-start gap-3';
                typingDiv.innerHTML = `
                    <div class="w-10 h-10 bg-iserv-green rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="bg-gray-100 rounded-2xl rounded-tl-sm px-5 py-3 inline-block">
                            <div class="flex items-center gap-2">
                                <div class="typing-indicator active">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                                <span class="text-sm text-gray-600 ml-2" id="loadingMessage">${initialMessage}</span>
                            </div>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Rotate messages every 2.5 seconds
                const messageElement = document.getElementById('loadingMessage');
                loadingMessageInterval = setInterval(() => {
                    const indicator = document.getElementById('typingIndicator');
                    if (messageElement && indicator) {
                        currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
                        messageElement.textContent = loadingMessages[currentMessageIndex];
                    } else {
                        clearInterval(loadingMessageInterval);
                        loadingMessageInterval = null;
                    }
                }, 2500);

            } else if (!isTyping && existingIndicator) {
                if (loadingMessageInterval) {
                    clearInterval(loadingMessageInterval);
                    loadingMessageInterval = null;
                }
                existingIndicator.remove();
            }
        }

        // Variable to track the current bot message element for streaming updates
        let currentBotMessageElement = null;
        let accumulatedText = '';

        /**
         * Add or update bot message with streaming text
         */
        function addOrUpdateBotMessage(text, isComplete = false) {
            // Don't create message if text is empty and not complete
            if (!text && !isComplete) return;
            
            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            if (!currentBotMessageElement) {
                // Create new message element only when we have text
                if (!text) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start gap-3';
                messageDiv.id = `bot-message-${Date.now()}`;
                
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-iserv-green rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1" style="max-width: calc(100% - 52px);">
                        <div class="thinking-chain-container"></div>
                        <div class="bg-gray-100 rounded-2xl rounded-tl-sm px-5 py-3 inline-block max-w-full">
                            <div class="text-gray-800 leading-relaxed whitespace-pre-wrap markdown-content bot-message-content"></div>
                        </div>
                        <div class="visualization-container"></div>
                        <p class="text-xs text-gray-400 mt-1 ml-1">${time}</p>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                currentBotMessageElement = messageDiv;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Update text content
            const contentDiv = currentBotMessageElement.querySelector('.bot-message-content');
            if (contentDiv && text) {
                contentDiv.innerHTML = renderMarkdown(text);
            }
            
            // Check for generative-bi block when complete
            if (isComplete && text) {
                console.log('[v0] Processing complete text, length:', text.length);
                console.log('[v0] Text includes generative-bi:', text.includes('generative-bi'));
                
                const biResult = parseGenerativeBIResponse(text);
                console.log('[v0] biResult:', { hasVisualization: biResult.hasVisualization, hasBiData: !!biResult.biData });
                
                const vizContainer = currentBotMessageElement.querySelector('.visualization-container');
                const thinkingContainer = currentBotMessageElement.querySelector('.thinking-chain-container');
                
                if (biResult.hasVisualization || biResult.biData) {
                    console.log('[v0] Rendering visualization, type:', biResult.biData?.visualization?.type);
                    const viz = biResult.biData?.visualization;
                    const thinking = biResult.biData?.thinking;
                    
                    // Render thinking chain if available
                    if (thinking && thinking.length > 0 && thinkingContainer) {
                        thinkingContainer.innerHTML = renderThinkingChain(thinking);
                    }
                    
                    // Always show the original text from the agent (biData.text has the full response)
                    const originalText = biResult.biData?.text || biResult.cleanText;
                    if (contentDiv && originalText) {
                        contentDiv.innerHTML = renderMarkdown(originalText);
                    }
                    
                    // Render visualization
                    if (viz && vizContainer) {
                        vizContainer.innerHTML = renderVisualization(viz);
                    }
                } else if (contentDiv) {
                    contentDiv.innerHTML = renderMarkdown(biResult.cleanText);
                }
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage(message) {
            if (!message || isProcessing || !sessionId) {
                if (!sessionId) {
                    console.warn('[v0] Cannot send message: No session ID available');
                    addMessage('Por favor espera a que se establezca la conexi√≥n.', 'system');
                }
                return;
            }

            // Disable input
            isProcessing = true;
            sendButton.disabled = true;
            messageInput.disabled = true;

            // Add user message to chat
            addMessage(message, 'user');

            // Show typing indicator
            setTyping(true);

            // Reset streaming variables
            currentBotMessageElement = null;
            accumulatedText = '';

            try {
                console.log('[v0] Sending message to:', `${API_BASE_URL}/run`);

                const response = await fetch(`${API_BASE_URL}/run`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        appName: APP_NAME,
                        userId: USER_ID,
                        session_id: sessionId,
                        newMessage: {
                            role: 'user',
                            parts: [{ text: message }]
                        }
                    })
                });

                console.log('[v0] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[v0] Error response:', errorText);
                    throw new Error(`Request failed: ${response.status} ${response.statusText}`);
                }

                // Hide typing indicator
                setTyping(false);

                const data = await response.json();
                console.log('[v0] Response received, data type:', typeof data);
                console.log('[v0] Response keys:', Object.keys(data || {}));
                
                let agentResponse = 'Disculpa, no pude procesar tu solicitud.';

                // Handle different response formats
                const events = Array.isArray(data) ? data : (data.events || []);
                console.log('[v0] Events count:', events.length);

                if (events.length > 0) {
                    // Look for the last event with text content
                    for (let i = events.length - 1; i >= 0; i--) {
                        const event = events[i];
                        console.log('[v0] Processing event', i, '- author:', event.author, '- has content:', !!event.content);
                        
                        if (event.content && event.content.parts) {
                            for (const part of event.content.parts) {
                                if (part.text) {
                                    agentResponse = part.text;
                    console.log('[v0] Found text response, length:', agentResponse.length);
                                        console.log('[v0] Response preview:', agentResponse.substring(0, 200));
                                        console.log('[v0] Has generative-bi:', agentResponse.includes('GENERATIVE_BI_START'));
                                    break;
                                }
                            }
                            if (agentResponse !== 'Disculpa, no pude procesar tu solicitud.') {
                                break;
                            }
                        }
                    }
                }

                // Add agent response to chat
                console.log('[v0] Adding message to chat, length:', agentResponse.length);
                addMessage(agentResponse, 'bot');

            } catch (error) {
                console.error('[v0] Request failed:', error);
                setTyping(false);

                let errorMsg = 'Error al comunicarse con el servidor. ';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg += 'Verifica tu conexi√≥n a internet. ';
                }
                errorMsg += `Detalles: ${error.message}`;

                addMessage(errorMsg, 'system');
            } finally {
                // Re-enable input
                isProcessing = false;
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
                currentBotMessageElement = null;
            }
        }

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter = enviar | Shift + Enter = nueva l√≠nea
        messageInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();       // evita salto de l√≠nea
                form.requestSubmit();    // dispara el submit existente
            }
        });


        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            
            if (message) {
                sendMessage(message);
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        });

        function addMessage(text, type, skipSave = false) {
            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            let biData = null; // Store Generative BI data for persistence
            
            if (type === 'system') {
                // System message (centered, different style)
                messageDiv.className = 'flex justify-center';
                messageDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl px-4 py-2 max-w-xl">
                        <p class="text-yellow-800 text-sm text-center">${escapeHtml(text)}</p>
                    </div>
                `;
            } else if (type === 'user') {
                messageDiv.className = 'flex items-start gap-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="flex-1 flex flex-col items-end">
                        <div class="bg-iserv-green rounded-2xl rounded-tr-sm px-5 py-3 inline-block max-w-xl">
                            <p class="text-white leading-relaxed">${escapeHtml(text)}</p>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 mr-1">${time}</p>
                    </div>
                    <div class="w-10 h-10 bg-iserv-black rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                `;
            } else {
                // Bot message - Check for Generative BI visualization
                console.log('[addMessage] Bot message, length:', text.length);
                console.log('[addMessage] Has generative-bi:', text.includes('generative-bi'));
                
                const biResult = parseGenerativeBIResponse(text);
                console.log('[addMessage] biResult:', { hasVisualization: biResult.hasVisualization, hasBiData: !!biResult.biData });
                
                let messageContent = '';
                let visualizationHtml = '';
                let thinkingHtml = '';

                if (biResult.hasVisualization || biResult.biData) {
                    // Store Generative BI data for persistence
                    biData = biResult.biData;
                    
                    const viz = biResult.biData?.visualization;
                    const thinking = biResult.biData?.thinking;
                    console.log('[addMessage] Viz type:', viz?.type, 'Visualizable:', viz?.visualizable);
                    
                    // Render thinking chain if available
                    if (thinking && thinking.length > 0) {
                        thinkingHtml = renderThinkingChain(thinking);
                    }
                    
                    // Render the visualization
                    if (viz) {
                        visualizationHtml = renderVisualization(viz);
                    }
                    
                    // Always show the original text from the agent (biData.text has the full response)
                    messageContent = biResult.biData?.text || biResult.cleanText;
                } else {
                    messageContent = biResult.cleanText;
                }

                messageDiv.className = 'flex items-start gap-3';
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-iserv-green rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1" style="max-width: calc(100% - 52px);">
                        ${thinkingHtml}
                        ${messageContent ? `
                        <div class="bg-gray-100 rounded-2xl rounded-tl-sm px-5 py-3 inline-block max-w-full">
                            <div class="text-gray-800 leading-relaxed whitespace-pre-wrap markdown-content">${renderMarkdown(messageContent)}</div>
                        </div>
                        ` : ''}
                        ${visualizationHtml}
                        <p class="text-xs text-gray-400 mt-1 ml-1">${time}</p>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Save to localStorage (unless explicitly skipped, e.g., when restoring from storage)
            if (!skipSave) {
                saveMessageToStorage(text, type, biData);
            }
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Render basic markdown to HTML
         * Supports: **bold**, *italic*, lists, line breaks
         */
        function renderMarkdown(text) {
            if (!text) return '';
            
            // Convert literal \n sequences to actual newlines (LLM sometimes outputs these as text)
            text = text.replace(/\\n/g, '\n');
            // Clean up excessive newlines
            text = text.replace(/\n{3,}/g, '\n\n');
            
            // Split into lines to process lists properly
            const lines = text.split('\n');
            const processedLines = [];
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Escape HTML first
                line = escapeHtml(line);
                
                // Check if it's a list item
                const listMatch = line.match(/^(\s*)[-*]\s+(.+)$/);
                const numberedMatch = line.match(/^(\s*)(\d+)\.\s+(.+)$/);
                
                if (listMatch || numberedMatch) {
                    if (!inList) {
                        processedLines.push('<ul class="markdown-list">');
                        inList = true;
                    }
                    const content = listMatch ? listMatch[2] : numberedMatch[3];
                    // Process bold and italic in list items
                    const processedContent = processInlineMarkdown(content);
                    processedLines.push(`<li class="markdown-list-item">${processedContent}</li>`);
                } else {
                    if (inList) {
                        processedLines.push('</ul>');
                        inList = false;
                    }
                    // Process inline markdown (bold, italic)
                    line = processInlineMarkdown(line);
                    if (line.trim()) {
                        processedLines.push(`<span class="text-line">${line}</span>`);
                    }
                }
            }
            
            if (inList) {
                processedLines.push('</ul>');
            }
            
            // Join content - lists don't need <br>, text lines do
            let result = '';
            for (let i = 0; i < processedLines.length; i++) {
                const current = processedLines[i];
                const next = processedLines[i + 1];
                result += current;
                // Add <br> only between text lines, not around lists
                if (current.includes('text-line') && next && next.includes('text-line')) {
                    result += '<br>';
                }
            }
            return result;
        }

        /**
         * Process inline markdown (bold, italic)
         */
        function processInlineMarkdown(text) {
            // Convert **bold** to <strong>
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Convert *italic* to <em> (but not if it's part of **bold**)
            // Use negative lookbehind/lookahead to avoid conflicts
            text = text.replace(/(?<!\*)\*([^*\n]+?)\*(?!\*)/g, '<em>$1</em>');
            
            return text;
        }

        initializeSession();

        // ============================================
        // SUGGESTED PROMPTS PANEL
        // ============================================

        // Quick prompts (shorter list for the bottom)
        const quickPrompts = [
            {
                text: "Total de compras por proveedor diciembre 2025",
                icon: "cart",
                highlight: "compras por proveedor"
            },
            {
                text: "centro de costos ultima semana",
                icon: "chart",
                highlight: "centro de costos"
            },
            {
                text: "facturas de los ultimos 3 meses por proyecto valor",
                icon: "invoice",
                highlight: "facturas"
            },
            {
                text: "presupuesto en GAB DEL PROYECTO PIAMONTE",
                icon: "money",
                highlight: "presupuesto"
            }
        ];

        const promptIcons = {
            cable: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>',
            building: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>',
            cart: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
            chart: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>',
            invoice: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
            money: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            trending: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>'
        };

        // Selected items state
        let selectedProducto = null;
        let selectedProveedor = null;
        let searchTimeout = null;

        function createPromptButtons() {
            const container = document.getElementById('quickPromptsContainer');
            if (!container) return;

            quickPrompts.forEach((prompt, index) => {
                const btn = document.createElement('button');
                btn.className = 'prompt-btn';
                btn.setAttribute('data-prompt', prompt.text);
                btn.setAttribute('title', prompt.text);
                
                // Highlight the key term in the text
                let displayText = prompt.text;
                if (prompt.highlight) {
                    displayText = prompt.text.replace(
                        new RegExp(`(${prompt.highlight})`, 'i'),
                        '<strong>$1</strong>'
                    );
                }

                btn.innerHTML = `
                    <div class="prompt-btn-icon">
                        ${promptIcons[prompt.icon] || promptIcons.chart}
                    </div>
                    <span class="prompt-btn-text">${displayText}</span>
                `;

                btn.addEventListener('click', () => {
                    sendSuggestedPrompt(prompt.text);
                });

                container.appendChild(btn);
            });

            // Initialize dropdown listeners
            initializeDropdowns();
        }

        function initializeDropdowns() {
            // Producto search
            const productoInput = document.getElementById('productoSearch');
            const productoList = document.getElementById('productoList');
            
            if (productoInput && productoList) {
                productoInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchProductos(e.target.value);
                    }, 300);
                });

                productoInput.addEventListener('focus', () => {
                    if (productoInput.value.length >= 2) {
                        searchProductos(productoInput.value);
                    }
                });
            }

            // Proveedor search
            const proveedorInput = document.getElementById('proveedorSearch');
            const proveedorList = document.getElementById('proveedorList');
            
            if (proveedorInput && proveedorList) {
                proveedorInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchProveedores(e.target.value);
                    }, 300);
                });

                proveedorInput.addEventListener('focus', () => {
                    if (proveedorInput.value.length >= 2) {
                        searchProveedores(proveedorInput.value);
                    }
                });
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-dropdown')) {
                    document.querySelectorAll('.dropdown-list').forEach(list => {
                        list.classList.remove('show');
                    });
                }
            });

            // Template buttons
            document.querySelectorAll('.query-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const template = btn.dataset.template;
                    executeTemplate(template);
                });
            });
        }

        async function searchProductos(query) {
            const list = document.getElementById('productoList');
            if (!list) return;

            if (query.length < 2) {
                list.classList.remove('show');
                return;
            }

            list.innerHTML = '<div class="dropdown-loading">Buscando</div>';
            list.classList.add('show');

            try {
                const response = await fetch(`${API_BASE_URL}/api/productos?search=${encodeURIComponent(query)}&limit=20`);
                const data = await response.json();

                if (data.error) {
                    list.innerHTML = '<div class="dropdown-empty">Error al buscar</div>';
                    return;
                }

                if (data.productos.length === 0) {
                    list.innerHTML = '<div class="dropdown-empty">No se encontraron productos</div>';
                    return;
                }

                list.innerHTML = data.productos.map(producto => {
                    const highlighted = highlightMatch(producto, query);
                    return `<div class="dropdown-item" data-value="${escapeHtml(producto)}">${highlighted}</div>`;
                }).join('');

                // Add click handlers
                list.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectProducto(item.dataset.value);
                    });
                });
            } catch (error) {
                console.error('Error searching productos:', error);
                list.innerHTML = '<div class="dropdown-empty">Error de conexi√≥n</div>';
            }
        }

        async function searchProveedores(query) {
            const list = document.getElementById('proveedorList');
            if (!list) return;

            if (query.length < 2) {
                list.classList.remove('show');
                return;
            }

            list.innerHTML = '<div class="dropdown-loading">Buscando</div>';
            list.classList.add('show');

            try {
                const response = await fetch(`${API_BASE_URL}/api/proveedores?search=${encodeURIComponent(query)}&limit=20`);
                const data = await response.json();

                if (data.error) {
                    list.innerHTML = '<div class="dropdown-empty">Error al buscar</div>';
                    return;
                }

                if (data.proveedores.length === 0) {
                    list.innerHTML = '<div class="dropdown-empty">No se encontraron proveedores</div>';
                    return;
                }

                list.innerHTML = data.proveedores.map(proveedor => {
                    const highlighted = highlightMatch(proveedor, query);
                    return `<div class="dropdown-item" data-value="${escapeHtml(proveedor)}">${highlighted}</div>`;
                }).join('');

                // Add click handlers
                list.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectProveedor(item.dataset.value);
                    });
                });
            } catch (error) {
                console.error('Error searching proveedores:', error);
                list.innerHTML = '<div class="dropdown-empty">Error de conexi√≥n</div>';
            }
        }

        function highlightMatch(text, query) {
            if (!query) return escapeHtml(text);
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escapeHtml(text).replace(regex, '<mark>$1</mark>');
        }

        function selectProducto(producto) {
            selectedProducto = producto;
            
            // Update input
            const input = document.getElementById('productoSearch');
            if (input) {
                input.value = producto;
            }

            // Hide dropdown
            const list = document.getElementById('productoList');
            if (list) {
                list.classList.remove('show');
            }

            // Enable and update template buttons
            const templates = document.getElementById('productoTemplates');
            if (templates) {
                templates.querySelectorAll('.query-template-btn').forEach(btn => {
                    btn.disabled = false;
                });
                
                // Update display names (truncate if too long)
                const displayName = producto.length > 25 ? producto.substring(0, 25) + '...' : producto;
                document.getElementById('selectedProductoName').textContent = displayName;
                document.getElementById('selectedProductoName2').textContent = displayName;
            }
        }

        function selectProveedor(proveedor) {
            selectedProveedor = proveedor;
            
            // Update input
            const input = document.getElementById('proveedorSearch');
            if (input) {
                input.value = proveedor;
            }

            // Hide dropdown
            const list = document.getElementById('proveedorList');
            if (list) {
                list.classList.remove('show');
            }

            // Enable and update template buttons
            const templates = document.getElementById('proveedorTemplates');
            if (templates) {
                templates.querySelectorAll('.query-template-btn').forEach(btn => {
                    btn.disabled = false;
                });
                
                // Update display names (truncate if too long)
                const displayName = proveedor.length > 20 ? proveedor.substring(0, 20) + '...' : proveedor;
                document.getElementById('selectedProveedorName').textContent = displayName;
                document.getElementById('selectedProveedorName2').textContent = displayName;
            }
        }

        function executeTemplate(template) {
            let query = '';
            
            switch (template) {
                case 'producto-precios':
                    if (selectedProducto) {
                        query = `${selectedProducto} dame los precios de las facturas y su estadistica descriptivo`;
                    }
                    break;
                case 'producto-compras':
                    if (selectedProducto) {
                        query = `COMPRAS MES A MES DE ${selectedProducto}`;
                    }
                    break;
                case 'proveedor-facturas':
                    if (selectedProveedor) {
                        query = `${selectedProveedor} facturas por mes`;
                    }
                    break;
                case 'proveedor-compras':
                    if (selectedProveedor) {
                        query = `Total de compras de ${selectedProveedor} ultimo a√±o`;
                    }
                    break;
            }

            if (query) {
                sendSuggestedPrompt(query);
            }
        }

        function sendSuggestedPrompt(text) {
            // Close the panel
            togglePromptsPanel(false);
            
            // Set the text in the input and send
            messageInput.value = text;
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
            
            // Send the message
            sendMessage(text);
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }

        function togglePromptsPanel(forceState = null) {
            const toggle = document.getElementById('promptsToggle');
            const container = document.getElementById('promptsContainer');
            
            if (!toggle || !container) return;

            const shouldShow = forceState !== null ? forceState : !container.classList.contains('show');
            
            if (shouldShow) {
                container.classList.add('show');
                toggle.classList.add('active');
            } else {
                container.classList.remove('show');
                toggle.classList.remove('active');
            }
        }

        // Initialize prompts panel on page load
        document.addEventListener('DOMContentLoaded', createPromptButtons);
        
        // If DOM is already loaded, create buttons now
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(createPromptButtons, 100);
        }
    </script>

    <!-- Floating Suggested Prompts Panel -->
    <div class="suggested-prompts-panel">
        <div id="promptsContainer" class="suggested-prompts-container">
            <div class="suggested-prompts-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                <span>Consultas Sugeridas</span>
            </div>

            <!-- Productos Dropdown -->
            <div class="dropdown-section">
                <div class="dropdown-label">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span>Buscar Producto</span>
                </div>
                <div class="search-dropdown">
                    <input 
                        type="text" 
                        id="productoSearch" 
                        class="search-input" 
                        placeholder="Ej: ALAMBRE, CABLE, TUBO..."
                        autocomplete="off"
                    >
                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <div id="productoList" class="dropdown-list"></div>
                </div>
                <div class="query-templates" id="productoTemplates">
                    <button class="query-template-btn" data-template="producto-precios" disabled>
                        üìä Precios y estad√≠stica de <strong id="selectedProductoName">selecciona producto</strong>
                    </button>
                    <button class="query-template-btn" data-template="producto-compras" disabled>
                        üõí Compras mensuales de <strong id="selectedProductoName2">selecciona producto</strong>
                    </button>
                </div>
            </div>

            <!-- Proveedores Dropdown -->
            <div class="dropdown-section">
                <div class="dropdown-label">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span>Buscar Proveedor</span>
                </div>
                <div class="search-dropdown">
                    <input 
                        type="text" 
                        id="proveedorSearch" 
                        class="search-input" 
                        placeholder="Ej: RYMEL, CABLECOL..."
                        autocomplete="off"
                    >
                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <div id="proveedorList" class="dropdown-list"></div>
                </div>
                <div class="query-templates" id="proveedorTemplates">
                    <button class="query-template-btn" data-template="proveedor-facturas" disabled>
                        üìÑ Facturas por mes de <strong id="selectedProveedorName">selecciona proveedor</strong>
                    </button>
                    <button class="query-template-btn" data-template="proveedor-compras" disabled>
                        üí∞ Total compras de <strong id="selectedProveedorName2">selecciona proveedor</strong>
                    </button>
                </div>
            </div>

            <div class="section-divider">Consultas r√°pidas</div>

            <!-- Prompt buttons will be inserted here by JavaScript -->
            <div id="quickPromptsContainer"></div>
        </div>
        <button 
            id="promptsToggle" 
            class="suggested-prompts-toggle" 
            onclick="togglePromptsPanel()"
            title="Ver consultas sugeridas"
        >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </button>
    </div>
</body>
</html>
