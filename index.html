<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-SERV BOT - Chatbot Interno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'iserv-green': '#009639',
                        'iserv-dark-green': '#00843D',
                        'iserv-black': '#1a1a1a',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .chat-container {
            height: calc(100vh - 80px);
        }
        
        .messages-container {
            height: calc(100% - 80px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: #009639;
            border-radius: 3px;
        }

        /* Added typing indicator animation */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #009639;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-6px);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="/static/images/LOGO-I-SERV.png" alt="Logo de I‑SERV" class="h-12 w-auto" width="48" height="48" loading="lazy">
                <div>
                    <h1 class="text-xl font-bold text-iserv-black">I-SERV BOT</h1>
                    <p class="text-sm text-gray-500">Asistente Virtual Interno</p>
                </div>
            </div>
            <!-- Updated status indicator to be dynamic -->
            <div class="flex items-center gap-2">
                <div id="statusIndicator" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span id="statusText" class="text-sm text-gray-600 font-medium">Conectando...</span>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <main class="max-w-5xl mx-auto px-6 py-6">
        <div class="bg-white rounded-2xl shadow-lg chat-container">
            <!-- Messages Area -->
            <div class="messages-container p-6 space-y-4" id="messagesContainer">
                <!-- Removed example messages, they will be added dynamically -->
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <form id="chatForm" class="flex items-end gap-3">
                    <textarea 
                        id="messageInput"
                        rows="1"
                        placeholder="Escribe tu mensaje aquí..."
                        class="flex-1 resize-none border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-iserv-green focus:border-transparent"
                        style="max-height: 120px;"
                    ></textarea>
                    <button 
                        type="submit"
                        id="sendButton"
                        class="bg-iserv-green text-white px-6 py-3 rounded-xl font-semibold hover:bg-iserv-dark-green transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span>Enviar</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Configuration - Read API_BASE_URL from meta tag or use current origin as fallback
        const apiBaseUrlMeta = document.querySelector('meta[name="api-base-url"]');
        const API_BASE_URL = apiBaseUrlMeta 
            ? apiBaseUrlMeta.getAttribute('content') 
            : (window.API_BASE_URL || window.location.origin);
        const APP_NAME = 'app';
        const USER_ID = 'web-user';

        // State
        let sessionId = null;
        let isProcessing = false;

        // DOM Elements
        const form = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const sendButton = document.getElementById('sendButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        async function initializeSession() {
            try {
                updateStatus('Conectando...', false);

                console.log('[v0] Attempting to connect to:', `${API_BASE_URL}/apps/${APP_NAME}/users/${USER_ID}/sessions`);

                const response = await fetch(`${API_BASE_URL}/apps/${APP_NAME}/users/${USER_ID}/sessions`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                console.log('[v0] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[v0] Error response:', errorText);
                    throw new Error(`Failed to create session: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                sessionId = data.id;

                updateStatus('En línea', true);
                console.log('[v0] Session initialized successfully:', sessionId);

                // Add welcome message
                addMessage('¡Hola! Soy I-SERV BOT, tu asistente virtual para gestión interna. ¿En qué puedo ayudarte hoy?', 'bot');

            } catch (error) {
                console.error('[v0] Error initializing session:', error);
                updateStatus('Error de conexión', false);

                let errorMsg = 'No se pudo conectar al servidor. ';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg += 'Por favor verifica que la API esté en ejecución. ';
                }
                errorMsg += `Error: ${error.message}`;

                addMessage(errorMsg, 'system');
            }
        }

        function updateStatus(message, isConnected) {
            statusText.textContent = message;
            statusIndicator.className = `w-2 h-2 rounded-full ${isConnected ? 'bg-iserv-green animate-pulse' : 'bg-red-500'}`;
        }

        function setTyping(isTyping) {
            const existingIndicator = document.getElementById('typingIndicator');
            
            if (isTyping && !existingIndicator) {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'flex items-start gap-3';
                typingDiv.innerHTML = `
                    <div class="w-10 h-10 bg-iserv-green rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="bg-gray-100 rounded-2xl rounded-tl-sm px-5 py-3 inline-block">
                            <div class="typing-indicator active">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else if (!isTyping && existingIndicator) {
                existingIndicator.remove();
            }
        }

        async function sendMessage(message) {
            if (!message || isProcessing || !sessionId) {
                if (!sessionId) {
                    console.warn('[v0] Cannot send message: No session ID available');
                    addMessage('Por favor espera a que se establezca la conexión.', 'system');
                }
                return;
            }

            // Disable input
            isProcessing = true;
            sendButton.disabled = true;
            messageInput.disabled = true;

            // Add user message to chat
            addMessage(message, 'user');

            // Show typing indicator
            setTyping(true);

            try {
                console.log('[v0] Sending message to:', `${API_BASE_URL}/run`);

                const response = await fetch(`${API_BASE_URL}/run`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        appName: APP_NAME,
                        userId: USER_ID,
                        session_id: sessionId,
                        newMessage: {
                            role: 'user',
                            parts: [{ text: message }]
                        }
                    })
                });

                console.log('[v0] Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[v0] Error response:', errorText);
                    throw new Error(`Agent request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('[v0] Response data received');

                // Hide typing indicator
                setTyping(false);

                // Extract agent response
                let agentResponse = 'Disculpa, no pude procesar tu solicitud.';

                const events = Array.isArray(data) ? data : (data.events || []);

                if (events.length > 0) {
                    // Find the last event with content from the agent
                    for (let i = events.length - 1; i >= 0; i--) {
                        const event = events[i];
                        if (event.content && event.content.parts) {
                            for (const part of event.content.parts) {
                                if (part.text) {
                                    agentResponse = part.text;
                                    break;
                                }
                            }
                            if (agentResponse !== 'Disculpa, no pude procesar tu solicitud.') {
                                break;
                            }
                        }
                    }
                }

                // Add agent response to chat
                addMessage(agentResponse, 'bot');

            } catch (error) {
                console.error('[v0] Error sending message:', error);
                setTyping(false);

                let errorMsg = 'Error al comunicarse con el servidor. ';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg += 'Verifica tu conexión a internet. ';
                }
                errorMsg += `Detalles: ${error.message}`;

                addMessage(errorMsg, 'system');
            } finally {
                // Re-enable input
                isProcessing = false;
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter = enviar | Shift + Enter = nueva línea
        messageInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();       // evita salto de línea
                form.requestSubmit();    // dispara el submit existente
            }
        });


        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            
            if (message) {
                sendMessage(message);
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        });

        function addMessage(text, type) {
            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            
            if (type === 'system') {
                // System message (centered, different style)
                messageDiv.className = 'flex justify-center';
                messageDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl px-4 py-2 max-w-xl">
                        <p class="text-yellow-800 text-sm text-center">${text}</p>
                    </div>
                `;
            } else if (type === 'user') {
                messageDiv.className = 'flex items-start gap-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="flex-1 flex flex-col items-end">
                        <div class="bg-iserv-green rounded-2xl rounded-tr-sm px-5 py-3 inline-block max-w-xl">
                            <p class="text-white leading-relaxed">${text}</p>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 mr-1">${time}</p>
                    </div>
                    <div class="w-10 h-10 bg-iserv-black rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                `;
            } else {
                // Bot message
                messageDiv.className = 'flex items-start gap-3';
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-iserv-green rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="bg-gray-100 rounded-2xl rounded-tl-sm px-5 py-3 inline-block max-w-xl">
                            <p class="text-gray-800 leading-relaxed">${text}</p>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 ml-1">${time}</p>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        initializeSession();
    </script>
</body>
</html>
