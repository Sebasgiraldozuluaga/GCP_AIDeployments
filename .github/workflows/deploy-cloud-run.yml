name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: 'aidevelopments'
  SERVICE_NAME: 'raju-agent'
  REGION: 'us-central1'
  REPOSITORY: 'raju-agent'
  IMAGE_NAME: 'us-central1-docker.pkg.dev/aidevelopments/raju-agent/raju-agent'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          echo "ğŸ” Validating required secrets..."

          # PostgreSQL secrets (required)
          if [ -z "${{ secrets.PG_HOST }}" ]; then
            echo "âŒ Error: PG_HOST secret is not configured"
            exit 1
          fi
          if [ -z "${{ secrets.PG_PASSWORD }}" ]; then
            echo "âŒ Error: PG_PASSWORD secret is not configured"
            exit 1
          fi
          echo "âœ… PostgreSQL secrets validated"

          # Hugging Face MCP secret (required for HF integration)
          if [ -z "${{ secrets.HF_TOKEN }}" ]; then
            echo "âš ï¸  Warning: HF_TOKEN secret is not configured"
            echo "   Hugging Face MCP features will not be available"
            echo "   Get your token at: https://huggingface.co/settings/tokens"
          else
            echo "âœ… Hugging Face MCP token configured"
          fi

          # GCP Service Account (required)
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "âŒ Error: GCP_SA_KEY secret is not configured"
            exit 1
          fi
          echo "âœ… GCP Service Account validated"

          echo "âœ… All validations passed"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Create Artifact Registry repository (if not exists)
        run: |
          gcloud artifacts repositories create ${{ env.REPOSITORY }} \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="Docker repository for raju-agent" \
            --quiet || true

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        env:
          DOCKER_BUILDKIT: 0
        run: |
          AGENT_VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' pyproject.toml | head -1)
          AGENT_VERSION=${AGENT_VERSION:-0.0.0}
          echo "Building with AGENT_VERSION=${AGENT_VERSION}"
          docker build \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --build-arg AGENT_VERSION="${AGENT_VERSION}" \
            -t "${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            -t "${{ env.IMAGE_NAME }}:latest" \
            .

      - name: Push Docker image
        run: |
          docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          AGENT_VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' pyproject.toml | head -1)
          AGENT_VERSION=${AGENT_VERSION:-0.0.0}

          echo "ğŸš€ Deploying to Cloud Run..."
          echo "   Version: ${AGENT_VERSION}"
          echo "   Commit: ${{ github.sha }}"
          echo "   Features: PostgreSQL Database + Hugging Face MCP"

          # Build environment variables configuration
          ENV_VARS_CONFIG="COMMIT_SHA=${{ github.sha }}"
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},AGENT_VERSION=${AGENT_VERSION}"

          # GCP Configuration
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}"
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},GOOGLE_CLOUD_LOCATION=${{ env.REGION }}"
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},GOOGLE_GENAI_USE_VERTEXAI=True"

          # PostgreSQL Database Configuration
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},PG_HOST=${{ secrets.PG_HOST }}"
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},PG_DATABASE=${{ secrets.PG_DATABASE }}"
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},PG_USER=${{ secrets.PG_USER }}"
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},PG_PASSWORD=${{ secrets.PG_PASSWORD }}"
          ENV_VARS_CONFIG="${ENV_VARS_CONFIG},PG_PORT=${{ secrets.PG_PORT }}"

          # Hugging Face MCP Integration
          # Enables: search_hf_models, search_hf_datasets, search_hf_spaces tools
          if [ -n "${{ secrets.HF_TOKEN }}" ]; then
            ENV_VARS_CONFIG="${ENV_VARS_CONFIG},HF_TOKEN=${{ secrets.HF_TOKEN }}"
            echo "âœ… Hugging Face MCP integration enabled"
          else
            echo "âš ï¸  Hugging Face MCP integration disabled (no HF_TOKEN)"
          fi

          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --memory 4Gi \
            --no-cpu-throttling \
            --port 8080 \
            --timeout 300 \
            --set-env-vars "${ENV_VARS_CONFIG}" \
            --labels "created-by=github-actions,commit-sha=${{ github.sha }}"
          
          # Get the service URL and set it as API_BASE_URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          # Update the service with API_BASE_URL and GOOGLE_API_KEY (if provided)
          ENV_VARS="API_BASE_URL=${SERVICE_URL}"
          if [ -n "${{ secrets.GOOGLE_API_KEY }}" ]; then
            ENV_VARS="${ENV_VARS},GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}"
          fi
          gcloud run services update ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --update-env-vars "${ENV_VARS}"
          
          echo "SERVICE_URL=${SERVICE_URL}" >> $GITHUB_OUTPUT

      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          SERVICE_URL="${{ steps.deploy.outputs.SERVICE_URL }}"

          # Wait for service to be ready
          echo "â³ Waiting for service to be ready..."
          sleep 10

          # Check if service is responding
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Service is responding (HTTP ${HTTP_STATUS})"
          else
            echo "âš ï¸  Service returned HTTP ${HTTP_STATUS}"
          fi

          # Verify environment variables are set
          echo ""
          echo "ğŸ“‹ Deployment Configuration:"
          echo "   Service URL: ${SERVICE_URL}"
          echo "   Region: ${{ env.REGION }}"
          echo "   Memory: 4Gi"
          echo "   Timeout: 300s"
          echo ""
          echo "ğŸ”§ Enabled Features:"
          echo "   âœ… PostgreSQL Database"
          echo "   âœ… Gemini 2.5 Flash (Vertex AI)"
          if [ -n "${{ secrets.HF_TOKEN }}" ]; then
            echo "   âœ… Hugging Face MCP Integration"
            echo "      â€¢ search_hf_models"
            echo "      â€¢ search_hf_datasets"
            echo "      â€¢ search_hf_spaces"
            echo "      â€¢ get_hf_model_details"
            echo "      â€¢ get_hf_dataset_details"
          else
            echo "   âš ï¸  Hugging Face MCP (disabled - no token)"
          fi

      - name: Output service URL
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ Deployment completed successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Service URL: ${{ steps.deploy.outputs.SERVICE_URL }}"
          echo ""
          echo "To test Hugging Face MCP integration, try:"
          echo '  curl -X POST "${{ steps.deploy.outputs.SERVICE_URL }}/api/chat" \'
          echo '    -H "Content-Type: application/json" \'
          echo '    -d '"'"'{"message": "Search for sentiment analysis models"}'"'"''
          echo ""

